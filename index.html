<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Experiencia AR Caballeros - Loop y 3D</title>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>

    <style>
        /* Evitar scroll y rebotes en mÃ³vil */
        html, body { margin: 0; padding: 0; overflow: hidden; width: 100%; height: 100%; font-family: sans-serif; background-color: #000; touch-action: none; }
        
        /* --- ESTRUCTURA DE CAPAS (Z-INDEX) --- */
        
        /* Z-0: Webcam (Fondo real) */
        #webcam {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: 0; transform: scaleX(-1); /* Espejo */
        }

        /* Z-1: Video Chroma (Transparente) */
        #output-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: 1; pointer-events: none; /* No bloquea clicks al 3D */
        }

        /* Z-2: Modelo 3D (Encima de todo) */
        model-viewer {
            width: 100%; height: 100%; position: absolute; top: 0; left: 0; 
            z-index: 2; outline: none; --poster-color: transparent;
        }

        /* UI y Controles */
        #audio-meter {
            position: fixed; top: 0; left: 0; height: 10px; width: 0%;
            background-color: #00ff00; z-index: 10000; transition: width 0.1s;
            box-shadow: 0 0 10px #00ff00;
        }

        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: white; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; z-index: 9999; 
            transition: opacity 0.6s ease-out; text-align: center;
        }
        
        #start-button {
            margin-top: 20px; padding: 25px 50px; background-color: #000; color: white;
            border: none; border-radius: 30px; font-size: 18px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* Aviso Landscape */
        #rotate-warning {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #1a1a1a; z-index: 20000;
            flex-direction: column; align-items: center; justify-content: center;
            color: white; text-align: center;
        }
        #rotate-icon { font-size: 50px; margin-bottom: 20px; animation: rotar 2s infinite ease-in-out; }
        @keyframes rotar { 0% { transform: rotate(0deg); } 50% { transform: rotate(-90deg); } 100% { transform: rotate(0deg); } }
        @media screen and (orientation: portrait) {
            #rotate-warning { display: flex; }
            #splash-screen { display: none; }
        }

        /* Video fuente oculto */
        #source-video { display: none; }

        #debug-text {
            position: fixed; top: 20px; left: 10px; color: yellow; font-weight: bold; 
            z-index: 10001; background: rgba(0,0,0,0.7); padding: 5px; font-size: 14px; max-width: 80%; word-wrap: break-word;
        }
    </style>
</head>
<body>

    <div id="rotate-warning">
        <div id="rotate-icon">ðŸ“± âž” ðŸ”„</div>
        <h2>Gira tu dispositivo</h2>
    </div>

    <div id="audio-meter"></div>
    <div id="debug-text">Cargando componentes...</div>

    <div id="splash-screen">
        <h2>EXPERIENCIA AR</h2>
        <p style="color: #666">Permite acceso a cÃ¡mara y sube volumen</p>
        <button id="start-button">INICIAR</button>
    </div>

    <video id="webcam" autoplay playsinline muted></video>
    
    <video id="source-video" loop playsinline crossOrigin="anonymous" preload="auto">
        <source src="caballeros.mp4" type="video/mp4">
    </video>

    <canvas id="output-canvas"></canvas>

    <model-viewer 
        id="viewer" 
        src="bolapoder1.glb" 
        alt="Modelo 3D" 
        camera-controls 
        auto-rotate
        shadow-intensity="1"
        environment-image="neutral"
        ar ar-modes="webxr scene-viewer quick-look"
    >
    </model-viewer>

    <script>
        const btn = document.getElementById('start-button');
        const sourceVideo = document.getElementById('source-video');
        const webcam = document.getElementById('webcam');
        const canvas = document.getElementById('output-canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const splash = document.getElementById('splash-screen');
        const meter = document.getElementById('audio-meter');
        const debug = document.getElementById('debug-text');
        const modelViewer = document.getElementById('viewer');

        let audioCtx, analyser, audioSource;
        let lastVibrateTime = 0;
        let isRunning = false;

        // --- NUEVO: DETECTOR DE ERRORES DEL MODELO 3D ---
        modelViewer.addEventListener('error', (e) => {
            console.error("Error cargando modelo 3D:", e);
            // Esto mostrarÃ¡ en la pantalla del mÃ³vil si falla el archivo 3D
            debug.innerText = "ERROR CRÃTICO 3D: No se pudo cargar 'bolapoder1.glb'. Verifica el nombre exacto en GitHub.";
            debug.style.color = "red";
            debug.style.fontSize = "18px";
        });
        
        modelViewer.addEventListener('load', () => {
             if(!isRunning) debug.innerText = "Modelo 3D cargado correctamente. Listo para iniciar.";
        });
        // ------------------------------------------------

        btn.addEventListener('click', async () => {
            if (navigator.vibrate) navigator.vibrate([100]);
            debug.innerText = "Iniciando cÃ¡mara y video...";

            try {
                setupAudio();
                await setupCamera();
                
                // Forzar inicio del video y asegurar que estÃ© en bucle
                sourceVideo.loop = true; 
                await sourceVideo.play();
                
                resizeCanvas();
                window.addEventListener('resize', resizeCanvas);

                splash.style.opacity = '0';
                setTimeout(() => splash.style.display = 'none', 600);
                
                isRunning = true;
                debug.innerText = "Experiencia activa. Gira si es necesario.";
                loopProcesamiento(); 

            } catch (e) {
                debug.innerText = "Error de Inicio: " + e.message;
                debug.style.color = "red";
            }
        });

        async function setupCamera() {
            // Intenta usar la cÃ¡mara trasera con una resoluciÃ³n Ã³ptima para rendimiento
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }, 
                audio: false 
            });
            webcam.srcObject = stream;
        }

        function setupAudio() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 256; 
            audioSource = audioCtx.createMediaElementSource(sourceVideo);
            audioSource.connect(analyser);
            analyser.connect(audioCtx.destination);
            sourceVideo.muted = false; 
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function loopProcesamiento() {
            if (!isRunning) return;
            requestAnimationFrame(loopProcesamiento);

            // CHROMA KEY
            if (sourceVideo.readyState >= sourceVideo.HAVE_CURRENT_DATA) {
                ctx.drawImage(sourceVideo, 0, 0, canvas.width, canvas.height);
                const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const l = frame.data.length;
                for (let i = 0; i < l; i += 4) {
                    const r = frame.data[i], g = frame.data[i+1], b = frame.data[i+2];
                    // Umbral de verde: Ajusta 1.3 si se borra mucho o poco
                    if (g > 90 && g > (r * 1.3) && g > (b * 1.3)) frame.data[i + 3] = 0;
                }
                ctx.putImageData(frame, 0, 0);
            }

            // AUDIO ANALISIS
            if (analyser) {
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                analyser.getByteFrequencyData(dataArray);
                let suma = 0, count = 0;
                for (let i = Math.floor(bufferLength * 0.5); i < bufferLength; i++) { suma += dataArray[i]; count++; }
                const volumenAgudos = suma / count;
                meter.style.width = (volumenAgudos * 4) + "%"; 
                
                if (volumenAgudos > 25) {
                    const now = Date.now();
                    if (now - lastVibrateTime > 150) {
                        if (navigator.vibrate) navigator.vibrate(100); 
                        lastVibrateTime = now;
                    }
                }
            }
        }
    </script>
</body>
</html>
