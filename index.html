<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Experiencia Caballeros - Vibración Sensible</title>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>

    <style>
        body { margin: 0; padding: 0; overflow: hidden; font-family: sans-serif; background-color: #000; }
        
        /* MEDIDOR VISUAL (Barra verde) */
        #audio-meter {
            position: fixed; top: 0; left: 0; height: 10px; width: 0%;
            background-color: #00ff00; z-index: 10000; transition: width 0.1s;
            box-shadow: 0 0 10px #00ff00;
        }

        #bg-video {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            object-fit: cover; z-index: 0; opacity: 0; transition: opacity 1s ease;
        }

        model-viewer {
            width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; 
            z-index: 1; outline: none; --poster-color: transparent;
        }

        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: white; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; z-index: 999; 
            transition: opacity 0.6s ease-out;
        }
        
        #start-button {
            margin-top: 20px; padding: 25px 50px; background-color: #000; color: white;
            border: none; border-radius: 30px; font-size: 18px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* Texto de estado para depuración (letras rojas/verdes) */
        #debug-text {
            position: fixed; top: 20px; left: 10px; color: yellow; font-weight: bold; 
            z-index: 10001; background: rgba(0,0,0,0.7); padding: 5px; font-size: 14px;
        }
    </style>
</head>
<body>

    <div id="audio-meter"></div>
    <div id="debug-text">Listo. Sube el volumen.</div>

    <div id="splash-screen">
        <h2>EXPERIENCIA 3D</h2>
        <p style="color: #666">Sube el volumen de tu celular</p>
        <button id="start-button">INICIAR EXPERIENCIA</button>
    </div>

    <video id="bg-video" loop playsinline crossOrigin="anonymous">
        <source src="caballeros.mp4" type="video/mp4">
    </video>

    <model-viewer 
        id="viewer" src="bolapoder1.glb" alt="3D Model" 
        camera-controls shadow-intensity="1">
    </model-viewer>

    <script>
        const btn = document.getElementById('start-button');
        const video = document.getElementById('bg-video');
        const splash = document.getElementById('splash-screen');
        const meter = document.getElementById('audio-meter');
        const debug = document.getElementById('debug-text');

        let audioCtx, analyser, source;
        let lastVibrateTime = 0;

        btn.addEventListener('click', async () => {
            // --- VIBRACIÓN DE PRUEBA INICIAL ---
            // Esto es crucial: Vibramos al hacer clic para "despertar" el motor.
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100]); // Vibración doble: bzz-bzz
                console.log("Vibración de prueba enviada");
            }

            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256; 

                source = audioCtx.createMediaElementSource(video);
                source.connect(analyser);
                analyser.connect(audioCtx.destination);

                video.muted = false; 
                await video.play();
                
                video.style.opacity = '1';
                splash.style.opacity = '0';
                setTimeout(() => splash.style.display = 'none', 600);

                loopAnalisis();

            } catch (e) {
                debug.innerText = "Error: " + e.message;
                video.play();
                video.style.opacity = '1';
                splash.style.display = 'none';
            }
        });

        function loopAnalisis() {
            requestAnimationFrame(loopAnalisis);
            
            if (!analyser) return;

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);

            // Calcular volumen de tonos altos
            let suma = 0;
            let count = 0;
            // Analizamos desde la mitad del espectro hacia arriba
            for (let i = Math.floor(bufferLength * 0.5); i < bufferLength; i++) {
                suma += dataArray[i];
                count++;
            }
            const volumenAgudos = suma / count;

            // Visual: Multiplicamos x5 para ver la barra moverse aunque el sonido sea bajo
            meter.style.width = (volumenAgudos * 5) + "%";
            
            // Debug en pantalla
            debug.innerText = "Nivel: " + Math.floor(volumenAgudos);

            // --- LÓGICA DE VIBRACIÓN AJUSTADA ---
            // UMBRAL: Mayor a 12 (muy sensible)
            if (volumenAgudos > 12) {
                const now = Date.now();
                
                // COOLDOWN: Esperar 150ms entre vibraciones para no saturar
                if (now - lastVibrateTime > 150) {
                    debug.style.color = "#00ff00"; // Texto verde
                    debug.innerText += " (VIBRANDO)";
                    
                    if (navigator.vibrate) {
                        // Vibrar 100 milisegundos
                        navigator.vibrate(100); 
                    }
                    lastVibrateTime = now;
                }
            } else {
                debug.style.color = "yellow";
            }
        }
    </script>
</body>
</html>
