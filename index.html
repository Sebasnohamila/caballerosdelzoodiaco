<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Experiencia Caballeros - Debug</title>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>

    <style>
        body { margin: 0; padding: 0; overflow: hidden; font-family: sans-serif; background-color: #000; }
        
        /* MEDIDOR VISUAL (Para ver si el código "escucha" el audio) */
        #audio-meter {
            position: fixed; top: 0; left: 0; height: 10px; width: 0%;
            background-color: #00ff00; z-index: 10000; transition: width 0.1s;
            box-shadow: 0 0 10px #00ff00;
        }

        #bg-video {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            object-fit: cover; z-index: 0; opacity: 0; transition: opacity 1s ease;
        }

        model-viewer {
            width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; 
            z-index: 1; outline: none; --poster-color: transparent;
        }

        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: white; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; z-index: 999; 
            transition: opacity 0.6s ease-out;
        }
        
        #start-button {
            margin-top: 20px; padding: 20px 40px; background-color: #000; color: white;
            border: none; border-radius: 30px; font-size: 16px; font-weight: bold; cursor: pointer;
        }

        /* Texto de estado para depuración */
        #debug-text {
            position: fixed; top: 20px; left: 10px; color: red; font-weight: bold; 
            z-index: 10001; background: rgba(0,0,0,0.7); padding: 5px; font-size: 12px;
        }
    </style>
</head>
<body>

    <div id="audio-meter"></div>
    <div id="debug-text">Esperando inicio...</div>

    <div id="splash-screen">
        <h2>EXPERIENCIA 3D</h2>
        <button id="start-button">TOCA AQUÍ PARA INICIAR</button>
    </div>

    <video id="bg-video" loop playsinline crossOrigin="anonymous">
        <source src="caballeros.mp4" type="video/mp4">
    </video>

    <model-viewer 
        id="viewer" src="bolapoder1.glb" alt="3D Model" 
        camera-controls shadow-intensity="1">
    </model-viewer>

    <script>
        const btn = document.getElementById('start-button');
        const video = document.getElementById('bg-video');
        const splash = document.getElementById('splash-screen');
        const meter = document.getElementById('audio-meter');
        const debug = document.getElementById('debug-text');

        let audioCtx, analyser, source;
        let lastVibrateTime = 0;

        btn.addEventListener('click', async () => {
            try {
                // 1. Inicializar AudioContext
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                
                // 2. Crear Analizador
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256; 

                // 3. Conectar Video -> Analizador -> Destino
                // Si esto falla por CORS, saldrá en el catch
                source = audioCtx.createMediaElementSource(video);
                source.connect(analyser);
                analyser.connect(audioCtx.destination);

                // 4. Reproducir Video
                video.muted = false; // Intentar sin mute
                await video.play();
                
                video.style.opacity = '1';
                splash.style.opacity = '0';
                setTimeout(() => splash.style.display = 'none', 600);

                // Iniciar análisis
                debug.innerText = "Audio iniciado. Mira la barra verde.";
                loopAnalisis();

            } catch (e) {
                console.error(e);
                debug.innerText = "ERROR: " + e.message;
                // Si falla createMediaElementSource, suele ser CORS.
                // Fallback: Reproducir video sin vibración
                video.play();
                video.style.opacity = '1';
                splash.style.display = 'none';
            }
        });

        function loopAnalisis() {
            requestAnimationFrame(loopAnalisis);
            
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);

            // Calcular volumen de agudos (última mitad del array)
            let suma = 0;
            let count = 0;
            for (let i = Math.floor(bufferLength * 0.6); i < bufferLength; i++) {
                suma += dataArray[i];
                count++;
            }
            const volumenAgudos = suma / count;

            // --- ACTUALIZAR BARRA VISUAL ---
            // Multiplicamos x2 para que se vea más evidente
            meter.style.width = (volumenAgudos * 2) + "%";
            
            // Debug texto con valor numérico
            debug.innerText = "Vol: " + Math.floor(volumenAgudos);

            // --- LOGICA DE VIBRACION ---
            // Bajamos el umbral a 60 para asegurar que vibre fácil
            if (volumenAgudos > 60) {
                const now = Date.now();
                // "Cooldown": Solo vibrar si pasaron 100ms desde la última vez
                // Esto evita que el motor se sature y deje de responder
                if (now - lastVibrateTime > 100) {
                    if (navigator.vibrate) {
                        navigator.vibrate(50); // Vibración corta
                        debug.innerText = "!!! VIBRANDO !!! (" + Math.floor(volumenAgudos) + ")";
                        debug.style.color = "#00ff00";
                    }
                    lastVibrateTime = now;
                }
            } else {
                debug.style.color = "red";
            }
        }
    </script>
</body>
</html>
