<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Dual - Entorno y 3D</title>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>

    <style>
        /* Reset y estructura bÃ¡sica */
        html, body { margin: 0; padding: 0; overflow: hidden; width: 100%; height: 100%; background-color: #000; touch-action: none; font-family: sans-serif; }
        
        /* --- CAPAS (Z-INDEX) --- */
        
        /* CAPA 0: Webcam (El entorno real) */
        #webcam {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: 0; 
        }

        /* CAPA 1: Modelo Fijo (AmbientaciÃ³n) 
           pointer-events: none es CLAVE: permite hacer clic a travÃ©s de Ã©l para tocar el otro modelo */
        #model-fixed {
            width: 100%; height: 100%; position: absolute; top: 0; left: 0; 
            z-index: 1; pointer-events: none;
            --poster-color: transparent;
        }

        /* CAPA 2: Modelo Interactivo (El que se mueve) */
        #model-interactive {
            width: 100%; height: 100%; position: absolute; top: 0; left: 0; 
            z-index: 2; 
            --poster-color: transparent;
        }

        /* UI: Medidor de Audio */
        #audio-meter {
            position: fixed; top: 0; left: 0; height: 10px; width: 0%;
            background-color: #00ff00; z-index: 10000; transition: width 0.1s;
            box-shadow: 0 0 10px #00ff00;
        }

        /* UI: Pantalla de Inicio */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.9); display: flex; flex-direction: column; 
            align-items: center; justify-content: center; z-index: 9999; 
            transition: opacity 0.6s ease-out; text-align: center;
        }
        
        #start-button {
            margin-top: 20px; padding: 25px 50px; background-color: #000; color: white;
            border: none; border-radius: 30px; font-size: 18px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* UI: Aviso Landscape */
        #rotate-warning {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #1a1a1a; z-index: 20000;
            flex-direction: column; align-items: center; justify-content: center;
            color: white; text-align: center;
        }
        #rotate-icon { font-size: 50px; margin-bottom: 20px; animation: rotar 2s infinite ease-in-out; }
        @keyframes rotar { 0% { transform: rotate(0deg); } 50% { transform: rotate(-90deg); } 100% { transform: rotate(0deg); } }
        
        @media screen and (orientation: portrait) {
            #rotate-warning { display: flex; }
            #splash-screen { display: none; }
        }

        #debug-text {
            position: fixed; top: 20px; left: 10px; color: white; font-weight: bold; text-shadow: 1px 1px 2px black;
            z-index: 10001; font-size: 14px; max-width: 80%; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="rotate-warning">
        <div id="rotate-icon">ðŸ“± âž” ðŸ”„</div>
        <h2>Gira tu dispositivo</h2>
    </div>

    <div id="audio-meter"></div>
    <div id="debug-text">Esperando inicio...</div>

    <div id="splash-screen">
        <h2>EXPERIENCIA DUAL AR</h2>
        <p style="color: #666">CÃ¡mara + Audio + 2 Modelos 3D</p>
        <button id="start-button">INICIAR EXPERIENCIA</button>
    </div>

    <video id="webcam" autoplay playsinline muted></video>
    
    <audio id="main-audio" loop crossOrigin="anonymous" preload="auto">
        <source src="caballeros.mp4" type="audio/mp4"> </audio>

    <model-viewer 
        id="model-fixed" 
        src="mcfront-v1.glb" 
        alt="Modelo Fondo" 
        shadow-intensity="1"
        environment-image="neutral"
        interaction-prompt="none"
        field-of-view="45deg"
        disable-zoom
        disable-tap
    >
    </model-viewer>

    <model-viewer 
        id="model-interactive" 
        src="finalspilberg-v1.glb" 
        alt="Modelo Interactivo" 
        camera-controls 
        autoplay
        shadow-intensity="1"
        environment-image="neutral"
        ar ar-modes="webxr scene-viewer quick-look"
    >
    </model-viewer>

    <script>
        const btn = document.getElementById('start-button');
        const audioEl = document.getElementById('main-audio');
        const webcam = document.getElementById('webcam');
        const splash = document.getElementById('splash-screen');
        const meter = document.getElementById('audio-meter');
        const debug = document.getElementById('debug-text');
        
        // Referencia al modelo interactivo por si necesitamos forzar el play
        const interactiveModel = document.getElementById('model-interactive');

        let audioCtx, analyser, audioSource;
        let lastVibrateTime = 0;
        let isRunning = false;

        btn.addEventListener('click', async () => {
            if (navigator.vibrate) navigator.vibrate([50]);
            debug.innerText = "Iniciando sistema...";

            try {
                // 1. Configurar Audio Context
                setupAudio();
                
                // 2. Iniciar Audio
                await audioEl.play();

                // 3. Iniciar CÃ¡mara
                await setupCamera();
                
                // 4. Asegurar que la animaciÃ³n del modelo corre al iniciar
                // (Aunque tiene autoplay, esto asegura que estÃ© corriendo si se pausÃ³ antes)
                if (interactiveModel.paused) {
                    interactiveModel.play();
                }
                
                // 5. Ocultar Splash
                splash.style.opacity = '0';
                setTimeout(() => splash.style.display = 'none', 600);
                
                isRunning = true;
                debug.innerText = ""; 
                loopAudioAnalysis(); 

            } catch (e) {
                debug.innerText = "Error: " + e.message;
                debug.style.color = "red";
                console.error(e);
            }
        });

        async function setupCamera() {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment', 
                    width: { ideal: 1280 }, 
                    height: { ideal: 720 } 
                }, 
                audio: false 
            });
            webcam.srcObject = stream;
        }

        function setupAudio() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 256; 
            
            audioSource = audioCtx.createMediaElementSource(audioEl);
            audioSource.connect(analyser);
            analyser.connect(audioCtx.destination);
        }

        function loopAudioAnalysis() {
            if (!isRunning) return;
            requestAnimationFrame(loopAudioAnalysis);

            if (analyser) {
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                analyser.getByteFrequencyData(dataArray);

                let suma = 0, count = 0;
                for (let i = Math.floor(bufferLength * 0.5); i < bufferLength; i++) { 
                    suma += dataArray[i]; 
                    count++; 
                }
                const promedio = suma / count;
                
                meter.style.width = (promedio * 4) + "%"; 
                
                if (promedio > 30) { 
                    const now = Date.now();
                    if (now - lastVibrateTime > 150) { 
                        if (navigator.vibrate) navigator.vibrate(40); 
                        lastVibrateTime = now;
                    }
                }
            }
        }
    </script>
</body>
</html>
